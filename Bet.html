<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6b7280, #1f2937);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            color: #e5e7eb;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .room-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .room-section input {
            padding: 12px;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 10px 0;
            width: 100%;
            max-width: 350px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            transition: border-color 0.3s, background 0.3s;
        }

        .room-section input:focus {
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .room-section input::placeholder {
            color: #d1d5db;
        }

        .room-section button {
            padding: 12px 24px;
            background: #60a5fa;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 5px;
            transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
        }

        .room-section button:hover {
            background: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .room-section button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .room-section p {
            margin-top: 15px;
            font-size: 16px;
            color: #d1d5db;
        }

        #roomIdText {
            font-weight: 600;
            color: #60a5fa;
        }

        #copyRoomBtn, #shareRoomBtn {
            background: #34d399;
            padding: 8px 16px;
            font-size: 14px;
        }

        #copyRoomBtn:hover, #shareRoomBtn:hover {
            background: #10b981;
        }

        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
            width: 100%;
        }

        video {
            width: 100%;
            max-width: 480px;
            height: 360px;
            background: #000;
            border-radius: 12px;
            border: 3px solid #60a5fa;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            object-fit: cover;
            transition: transform 0.3s;
        }

        video:hover {
            transform: scale(1.02);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
        }

        #startCallBtn {
            background: #34d399;
            color: white;
        }

        #startCallBtn:hover {
            background: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #endCallBtn {
            background: #f87171;
            color: white;
        }

        #endCallBtn:hover {
            background: #ef4444;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #muteAudioBtn, #muteVideoBtn {
            background: #facc15;
            color: #1f2937;
        }

        #muteAudioBtn:hover, #muteVideoBtn:hover {
            background: #eab308;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .controls button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease-in-out forwards;
        }

        @keyframes slideUp {
            0% { transform: translateX(-50%) translateY(20px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            video {
                max-width: 100%;
                height: 200px;
            }

            .room-section {
                padding: 15px;
            }

            .room-section input {
                max-width: 100%;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .controls button {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Call App</h1>
        <div class="room-section">
            <button id="generateRoomBtn">Generate Room ID</button>
            <p id="roomIdDisplay" style="display: none;">
                Room ID: <span id="roomIdText"></span>
                <button id="copyRoomBtn">Copy</button>
                <button id="shareRoomBtn">Share via WhatsApp</button>
            </p>
            <input type="text" id="roomIdInput" placeholder="Enter Room ID">
            <button id="joinRoomBtn">Join Room</button>
        </div>
        <div class="video-container">
            <video id="localVideo" autoplay playsinline muted></video>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        <div class="controls">
            <button id="startCallBtn" disabled>Start Call</button>
            <button id="endCallBtn" disabled>End Call</button>
            <button id="muteAudioBtn" disabled>Mute Audio</button>
            <button id="muteVideoBtn" disabled>Mute Video</button>
        </div>
    </div>

    <script>
        // WebRTC variables
        let localStream;
        let peerConnection;
        let roomId;
        let pollingInterval;
        let isAudioMuted = false;
        let isVideoMuted = false;
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' } // Free STUN server
                // Add TURN server if needed: { urls: 'turn:your-turn-server', username: 'user', credential: 'pass' }
            ]
        };

        // DOM elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const generateRoomBtn = document.getElementById('generateRoomBtn');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const roomIdText = document.getElementById('roomIdText');
        const copyRoomBtn = document.getElementById('copyRoomBtn');
        const shareRoomBtn = document.getElementById('shareRoomBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const startCallBtn = document.getElementById('startCallBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const muteAudioBtn = document.getElementById('muteAudioBtn');
        const muteVideoBtn = document.getElementById('muteVideoBtn');

        // Google Apps Script URL (replace with your deployed script URL)
        const signalingServerUrl = 'https://script.google.com/macros/s/AKfycbxikbiB1oPLKovOs0a9jpSbqFiWGyjyldCfOP320Gl4tx970-kmH2iJzNaYrGfLV754/exec'; // Replace with the URL from Step 1

        // Show toast messages
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() {
                toast.remove();
            }, 3000);
        }

        // Generate a unique Room ID
        function generateRoomId() {
            return 'room-' + Math.random().toString(36).substr(2, 9);
        }

        // Get user media (video and audio)
        function startLocalStream() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function(stream) {
                    localStream = stream;
                    localVideo.srcObject = stream;
                    muteAudioBtn.disabled = false;
                    muteVideoBtn.disabled = false;
                    showToast('Camera and microphone accessed successfully.');
                })
                .catch(function(error) {
                    console.error('Error accessing media devices:', error);
                    showToast('Could not access camera and microphone. Please check permissions.');
                });
        }

        // Initialize WebRTC peer connection
        function createPeerConnection() {
            try {
                peerConnection = new RTCPeerConnection(configuration);

                // Add local stream tracks to the peer connection
                localStream.getTracks().forEach(function(track) {
                    peerConnection.addTrack(track, localStream);
                });

                // Handle incoming remote stream
                peerConnection.ontrack = function(event) {
                    remoteVideo.srcObject = event.streams[0];
                };

                // Handle ICE candidates
                peerConnection.onicecandidate = function(event) {
                    if (event.candidate) {
                        sendSignalingMessage({
                            type: 'candidate',
                            candidate: event.candidate,
                            roomId: roomId
                        });
                    }
                };

                // Handle connection state changes
                peerConnection.onconnectionstatechange = function() {
                    console.log('Connection state:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        startCallBtn.disabled = true;
                        endCallBtn.disabled = false;
                        showToast('Connected to peer! Enjoy your call.');
                    } else if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
                        endCall();
                        showToast('Disconnected from peer. Call ended.');
                    }
                };
            } catch (error) {
                console.error('Error creating peer connection:', error);
                showToast('Failed to create peer connection.');
            }
        }

        // Send signaling messages to the server
        function sendSignalingMessage(message) {
            fetch(signalingServerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(message)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(result) {
                if (result.error) {
                    showToast('Error sending message: ' + result.error);
                }
            })
            .catch(function(error) {
                console.error('Error sending signaling message:', error);
                showToast('Error communicating with server. Please try again.');
            });
        }

        // Poll the server for signaling messages
        function pollSignalingMessages() {
            fetch(signalingServerUrl + '?roomId=' + roomId)
                .then(function(response) {
                    return response.json();
                })
                .then(function(messages) {
                    if (messages.error) {
                        showToast('Error fetching messages: ' + messages.error);
                        return;
                    }

                    messages.forEach(function(message) {
                        try {
                            if (message.type === 'offer') {
                                if (!peerConnection) createPeerConnection();
                                peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer))
                                    .then(function() {
                                        return peerConnection.createAnswer();
                                    })
                                    .then(function(answer) {
                                        return peerConnection.setLocalDescription(answer);
                                    })
                                    .then(function() {
                                        sendSignalingMessage({ type: 'answer', answer: peerConnection.localDescription, roomId: roomId });
                                    })
                                    .catch(function(error) {
                                        console.error('Error handling offer:', error);
                                        showToast('Error processing offer.');
                                    });
                            } else if (message.type === 'answer') {
                                peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer))
                                    .catch(function(error) {
                                        console.error('Error handling answer:', error);
                                        showToast('Error processing answer.');
                                    });
                            } else if (message.type === 'candidate') {
                                peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate))
                                    .catch(function(error) {
                                        console.error('Error handling candidate:', error);
                                        showToast('Error processing ICE candidate.');
                                    });
                            }
                        } catch (error) {
                            console.error('Error processing message:', error);
                        }
                    });
                })
                .catch(function(error) {
                    console.error('Error polling signaling messages:', error);
                    showToast('Error polling server. Please check your connection.');
                });
        }

        // Start the call
        function startCall() {
            try {
                createPeerConnection();
                peerConnection.createOffer()
                    .then(function(offer) {
                        return peerConnection.setLocalDescription(offer);
                    })
                    .then(function() {
                        sendSignalingMessage({ type: 'offer', offer: peerConnection.localDescription, roomId: roomId });
                        // Start polling for signaling messages
                        pollingInterval = setInterval(pollSignalingMessages, 2000); // Poll every 2 seconds
                        showToast('Starting call... Waiting for peer to join.');
                    })
                    .catch(function(error) {
                        console.error('Error creating offer:', error);
                        showToast('Error starting call.');
                    });
            } catch (error) {
                console.error('Error in startCall:', error);
                showToast('Failed to start call.');
            }
        }

        // End the call
        function endCall() {
            try {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
                remoteVideo.srcObject = null;
                startCallBtn.disabled = false;
                endCallBtn.disabled = true;
                muteAudioBtn.disabled = true;
                muteVideoBtn.disabled = true;
                isAudioMuted = false;
                isVideoMuted = false;
                muteAudioBtn.textContent = 'Mute Audio';
                muteVideoBtn.textContent = 'Mute Video';
                showToast('Call ended.');
            } catch (error) {
                console.error('Error in endCall:', error);
                showToast('Error ending call.');
            }
        }

        // Generate Room ID
        generateRoomBtn.addEventListener('click', function() {
            try {
                roomId = generateRoomId();
                roomIdText.textContent = roomId;
                roomIdDisplay.style.display = 'block';
                generateRoomBtn.disabled = true;
                roomIdInput.disabled = true;
                joinRoomBtn.disabled = true;
                startLocalStream();
                startCallBtn.disabled = false;
                showToast('Room ID generated! Share it with your friend.');
            } catch (error) {
                console.error('Error generating Room ID:', error);
                showToast('Error generating Room ID.');
            }
        });

        // Copy Room ID to clipboard
        copyRoomBtn.addEventListener('click', function() {
            navigator.clipboard.writeText(roomId)
                .then(function() {
                    showToast('Room ID copied to clipboard!');
                })
                .catch(function() {
                    showToast('Failed to copy Room ID.');
                });
        });

        // Share Room ID via WhatsApp
        shareRoomBtn.addEventListener('click', function() {
            try {
                var shareUrl = 'https://api.whatsapp.com/send?text=Join my video call! Room ID: ' + roomId;
                window.open(shareUrl, '_blank');
                showToast('Opening WhatsApp to share Room ID.');
            } catch (error) {
                console.error('Error sharing Room ID:', error);
                showToast('Error sharing Room ID.');
            }
        });

        // Join a room
        joinRoomBtn.addEventListener('click', function() {
            try {
                roomId = roomIdInput.value.trim();
                if (!roomId) {
                    showToast('Please enter a Room ID');
                    return;
                }

                startLocalStream();
                startCallBtn.disabled = false;
                joinRoomBtn.disabled = true;
                roomIdInput.disabled = true;
                generateRoomBtn.disabled = true;
                roomIdDisplay.style.display = 'none';
                showToast('Joined room. Click Start Call to begin.');
            } catch (error) {
                console.error('Error joining room:', error);
                showToast('Error joining room.');
            }
        });

        // Start call button
        startCallBtn.addEventListener('click', startCall);

        // End call button
        endCallBtn.addEventListener('click', endCall);

        // Mute audio button
        muteAudioBtn.addEventListener('click', function() {
            try {
                isAudioMuted = !isAudioMuted;
                localStream.getAudioTracks().forEach(function(track) {
                    track.enabled = !isAudioMuted;
                });
                muteAudioBtn.textContent = isAudioMuted ? 'Unmute Audio' : 'Mute Audio';
                showToast(isAudioMuted ? 'Audio muted.' : 'Audio unmuted.');
            } catch (error) {
                console.error('Error muting audio:', error);
                showToast('Error muting audio.');
            }
        });

        // Mute video button
        muteVideoBtn.addEventListener('click', function() {
            try {
                isVideoMuted = !isVideoMuted;
                localStream.getVideoTracks().forEach(function(track) {
                    track.enabled = !isVideoMuted;
                });
                muteVideoBtn.textContent = isVideoMuted ? 'Unmute Video' : 'Mute Video';
                showToast(isVideoMuted ? 'Video muted.' : 'Video unmuted.');
            } catch (error) {
                console.error('Error muting video:', error);
                showToast('Error muting video.');
            }
        });
    </script>
</body>
</html>